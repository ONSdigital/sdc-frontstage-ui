<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Surveys</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css" />
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" rel="stylesheet" />
<link href="/site.min.css" type="text/css" rel="stylesheet" />
<link rel="icon" href="favicon.ico" type="image/x-icon" />
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" type="text/css" rel="stylesheet" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.3.0/mustache.min.js"></script>


<script>

    $(document).ready(function () {
        $('.survey-item .btn-primary').on('click', function (e) {
            e.stopPropagation();
        });
    });

</script>

    <script>
        var partialsRegister = {};

        function getPartial (loc, callback) {

        	if (partialsRegister[loc]) {
        		callback(partialsRegister[loc]);
        		return partialsRegister[loc];
            }

            return $.get(loc, function (template) {
                partialsRegister[loc] = template;

                if (callback) {
                    callback(template);
                }
            });
        }

        (function () {

            var surveysListDefault = [
                {
                    "@metadata": {
                    	"id": "manual_1",
                        "type": "surveyInactive",
                        "template": "/partials/survey-inactive-item.mustache",
                        "inactive": "true"
                    },
                    "@value": {

                        /**
                         * Survey
                         */
                        "name": "Annual Survey Hours and Earnings",
                        "short_desc": "Data on levels, distribution and make-up of earnings and hours worked for UK employees by sex and full-time or part-time status in all industries and occupations.",
                        "reporting_unit": "Penn Pharmaceuticals",
                        "reporting_unit_ref": "243957812",
                        "period": "2016",
                        "return_by": "31 Dec 2016",
                        "status": "Waiting for activation",
                        "survey_link": "/blank/index.html",
                        "primaryAction": "Use code to activate"
                    }
                },
                {
                    "@metadata": {
                        "id": "manual_2",
                        "type": "survey",
                        "template": "/partials/survey-item.mustache",
                    },
                    "@value": {

                        /**
                         * Survey
                         */
                        "name": "Monthly Wages and Salaries Survey",
                        "reporting_unit": "Penn Pharmaceuticals",
                        "reporting_unit_ref": "243957812",
                        "period": "October 2016",
                        "return_by": "15 Dec 2016",
                        "status": "Not Started",
                        "survey_link": "/monthly-wages-salaries/index.htm",
                        "primaryAction": "Start survey"
                    }
                },
                {
                    "@metadata": {
                        "id": "manual_3",
                        "type": "message",
                        "template": "/partials/message-item.mustache",
                    },
                    "@value": {

                        /**
                         * Message
                         */
                        "subject": "You have a message regarding your Monthly Wages and Salaries Survey",
                        "message": "<h2>Refinements needed for your monthly wages...</h2><p>We have questions regarding your monthly wage figures. Please can you take some time to review our comments below.</p><p>Message details...</p>"
                    }
                },
                {
                    "@metadata": {
                        "id": "manual_4",
                        "type": "survey",
                        "template": "/partials/survey-item.mustache",
                    },
                    "@value": {

                        /**
                         * Survey
                         */
                        "name": "Monthly Wages and Salaries Survey",
                        "reporting_unit": "Penn Pharmaceuticals",
                        "reporting_unit_ref": "243957812",
                        "period": "October 2016",
                        "return_by": "15 Dec 2016",
                        "status": "In progress",
                        "survey_link": "/monthly-wages-salaries/index.htm",
                        "primaryAction": "Continue survey"
                    }
                }
            ],
            surveysList;

            if (!window.localStorage.getItem('surveys')) {
                window.localStorage.setItem('surveys', JSON.stringify(surveysListDefault));
            }

            surveysList = JSON.parse(window.localStorage.getItem('surveys'));

            $.when(
            	getPartial("/partials/survey-inactive-item.mustache"),
                getPartial("/partials/survey-item.mustache"),
                getPartial("/partials/message-item.mustache")
            ).done(function () {

                var html = '';

                function initSurveyList () {

                    /**
                     * Render HTML from templates and custome localStorage data
                     */
                    $('#survey-list-interactive').html(html);
                    $('.collapsible').collapsible();
                }

                surveysList.forEach(function (item) {

                    if (!item['@metadata'].template || item['@metadata'].template === '') {
                        console.log('No template partial found for ', item);
                        return;
                    }

                    getPartial(item['@metadata'].template, function (template) {
                        html += Mustache.render(template, item);
                    });
                });

                initSurveyList();
            });
        }());
    </script>
</head>
<body>
    <div class="page">


<div class="main-logo-container">
    <div class="container">
        <a href="/" class="main-logo-wrap">
            <img class="main-logo" src="https://www.ons.gov.uk//assets/img/ons-logo.svg" alt="Office for National Statistics">
        </a>

        <a href="/" class="logo-title">ONS Surveys</a>

        <div class="respondant-settings">
            <a class="help" href="#">Help</a>
        </div>
    </div>
</div>
        <div class="container">

            <div class="page-content">

                <!-- Content -->
<script>
    var surveysCtrl = (function () {

        var items = {},

            itemTypes = {
                survey: [
                    {
                        key: 'name',
                        field_type: 'text'
                    },
                    {
                        key: 'short_desc',
                        field_type: 'textarea'
                    },
                    {
                        key: 'reporting_unit',
                        field_type: 'text'
                    },
                    {
                        key: 'reporting_unit_ref',
                        field_type: 'text'
                    },
                    {
                        key: 'period',
                        field_type: 'text'
                    },
                    {
                        key: 'return_by',
                        field_type: 'text'
                    },
                    {
                        key: 'status',
                        field_type: 'text'
                    },
                    {
                        key: 'survey_link',
                        field_type: 'text'
                    },
                    {
                        key: 'primaryAction',
                        field_type: 'text'
                    }
                ],
                surveyInactive: [
                    {
                        key: 'name',
                        field_type: 'text'
                    },
                    {
                        key: 'short_desc',
                        field_type: 'textarea'
                    },
                    {
                        key: 'reporting_unit',
                        field_type: 'text'
                    },
                    {
                        key: 'reporting_unit_ref',
                        field_type: 'text'
                    },
                    {
                        key: 'period',
                        field_type: 'text'
                    },
                    {
                        key: 'return_by',
                        field_type: 'text'
                    },
                    {
                        key: 'status',
                        field_type: 'text'
                    },
                    {
                        key: 'survey_link',
                        field_type: 'text'
                    },
                    {
                        key: 'primaryAction',
                        field_type: 'text'
                    }
                ],
                message: [
                    {
                        key: 'subject',
                        field_type: 'text'
                    },
                    {
                        key: 'message',
                        field_type: 'textarea'
                    }
                ]
            },
            itemTypePartials = {
        	    survey: "/partials/survey-item.mustache",
                surveyInactive: "/partials/survey-inactive-item.mustache",
                message: "/partials/message-item.mustache"
            };

        function update() {
        	console.log('============= UPDATE ==============');
            items = JSON.parse(window.localStorage.getItem('surveys')) || [];

            /**
             * Completely refresh the UI
             */
            $('#survey-list-fields').html(
                items.map(function (item) {
                    return editableItem({
                    	id: item['@metadata'].id,
                    	type: item['@metadata'].type,
                        existingValues: item['@value']
                    });
                }).join('')
            );
        }

        function reset() {
            window.localStorage.clear();
            $('#survey-list-fields').html('');
            update();
        }

        function editableItem (itemData) {

        	if(!itemData.type) {
        		console.log('Item type not specified.');
        		return false;
            }

            var itemProfile = {
                id: itemData.id || 'item_' + Math.floor(Math.random() * 999999999999) + 1,
                fields: []
            };

        	/**
             * Override default values
             */
        	$.extend(itemProfile, itemData);

            return '<ul class="survey-list-field-group" id="' + itemProfile.id + '">' +

                itemTypes[itemProfile.type].map(function (item) {

                    var field = '',
                            fieldKey = Math.floor(Math.random() * 999999999999) + 1,
                            val = itemProfile.existingValues ? itemProfile.existingValues[item.key] : '',
                            valAttr = val ? 'value="' + val + '"' : '';

                    if (item.field_type === 'text') {
                        field = '<input type="text" id="field_' + fieldKey + '" ' + valAttr + ' />';
                    }
                    else if (item.field_type === 'textarea') {
                        field = '<textarea id="field_' + fieldKey + '">' + val + '</textarea>';
                    }

                    itemProfile.fields.push({
                        key: item.key,
                        field_key: 'field_' + fieldKey
                    });

                    return '<li>' +
                            '<label>' + item.key + '</label>' +
                            field +
                            '</li>';

                }).join('') +

                "<li><button class='btn btn-primary' onclick='return surveysCtrl.save(" + JSON.stringify(itemProfile) + ")'>Save</button></li>" +
            '</ul>';
        }

        function saveItem(itemProfile) {

        	var vals = {};

        	itemProfile.fields.forEach(function (item) {
                vals[item.key] = $('#' + item.field_key).val();
            });

        	if (itemProfile.existingValues) {

                /**
                 * Save changes to existing item
                 */
                items = items.map(function (item) {

                	if (item['@metadata'].id === itemProfile.id) {
                        item['@value'] = vals;
                    }
                	return item;
                });
            }
            else{

                /**
                 * Save new item
                 */
                items.push({
                    "@metadata": {
                        id: itemProfile.id,
                        template: itemTypePartials[itemProfile.type],
                        type: itemProfile.type
                    },
                    "@value": vals
                });
            }

            window.localStorage.setItem('surveys', JSON.stringify(items));

            update();

        	return false;
        }

        function addNewItem (type) {

            $('#survey-list-fields').append(editableItem({
            	type: type
            }));
        }

        $(document).ready(update);

        return {
            add: addNewItem,
            save: saveItem,
            reset: reset
        }

    }());
</script>

<style>
    select {
        display : block;
    }

    textarea {
        height : 100px;
    }

    .survey-list-field-group {
        padding : 20px !important;
        text-align : right;
        border : 1px solid #ccc;
    }

    .survey-list-field-group li {
        margin-bottom : 10px;
        border-bottom : 1px dotted #ccc;
    }

    .survey-list-field-group input[type=text],
    .survey-list-field-group textarea {
        width : 50%;
    }

    .survey-list-field-group label {
        float : left;
    }
</style>

<button class="btn btn-primary right" onclick="surveysCtrl.reset()">Clear cache</button>

<h4>Add item</h4>
<div>
    <select id="add-item">
        <option value="survey">New survey</option>
        <option value="surveyInactive">New inactive survey</option>
        <option value="message">New message</option>
    </select>
    <button class="btn btn-primary" onclick="surveysCtrl.add($('#add-item').val())">Add</button>
</div>
<br />

<form>
    <div id="survey-list-fields">

    </div>
</form>
                <!-- End Content -->

            </div>

<div class="footer">
    <p>This service is an alpha version, which means it is a trial service.</p>
    <p><a href="">Terms of Use</a> <a href="">Privacy Policy</a> <a href="">Copyright</a></p>
    <p><a href="">Office for National Statistics main website</a> <a href="">National Statistics Publication Hub</a> <a href="">United Kingdom Statistics Authority</a></p>
</div>

        </div>

    </div>
</body>
</html>
